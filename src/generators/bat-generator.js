import {
  groupSoftwareByCategory,
  getConfigObjects,
  formatWingetCommand,
  getDateTime,
} from './script-utils';

/**
 * Generate Windows Batch (.bat) script
 * @param {Array} selectedSoftwareIds - Array of selected software IDs
 * @param {Array} selectedConfigIds - Array of selected configuration IDs
 * @returns {string} - Generated batch script
 */
export const generateBatchScript = (selectedSoftwareIds, selectedConfigIds) => {
  const header = generateBatchHeader();
  const softwareSection = generateBatchSoftwareSection(selectedSoftwareIds);
  const configSection = generateBatchConfigSection(selectedConfigIds);
  const footer = generateBatchFooter();

  return header + softwareSection + configSection + footer;
};

/**
 * Generate batch script header
 */
const generateBatchHeader = () => {
  return `@echo off
chcp 65001 >nul
echo ========================================
echo Windows Post-Install Script (.bat)
echo Generated: ${getDateTime()}
echo ========================================
echo.

:: Check for Administrator privileges
net session >nul 2>&1
if %errorLevel% neq 0 (
    echo ERROR: This script requires Administrator privileges.
    echo Please right-click and select "Run as administrator"
    echo.
    pause
    exit /b 1
)

echo Starting installation process...
echo.
`;
};

/**
 * Generate software installation section
 */
const generateBatchSoftwareSection = (selectedIds) => {
  if (!selectedIds || selectedIds.length === 0) {
    return `:: No software selected for installation\necho No software selected.\necho.\n\n`;
  }

  let script = `::============================================
:: SOFTWARE INSTALLATION
::============================================
echo.
echo Installing selected software...
echo This may take a while depending on your internet connection.
echo.
`;

  const grouped = groupSoftwareByCategory(selectedIds);

  Object.entries(grouped).forEach(([categoryName, softwares]) => {
    script += `\n:: ${categoryName}\n`;
    script += `echo Installing ${categoryName}...\n`;

    softwares.forEach((software) => {
      script += `echo   - ${software.name}\n`;
      script += `${formatWingetCommand(software.wingetId)} 2>>errors.log\n`;
    });

    script += `echo.\n`;
  });

  return script + '\n';
};

/**
 * Generate configuration section
 */
const generateBatchConfigSection = (selectedIds) => {
  if (!selectedIds || selectedIds.length === 0) {
    return `:: No system configurations selected\necho No system configurations selected.\necho.\n\n`;
  }

  let script = `::============================================
:: SYSTEM CONFIGURATIONS
::============================================
echo.
echo Applying system configurations...
echo.
`;

  const configs = getConfigObjects(selectedIds);

  configs.forEach((config) => {
    script += `\n:: ${config.name}\n`;
    script += `echo Applying: ${config.name}\n`;

    // Add registry commands
    if (config.registryBat && config.registryBat.length > 0) {
      config.registryBat.forEach((cmd) => {
        script += `${cmd}\n`;
      });
    }

    // Add regular commands
    if (config.commandBat && config.commandBat.length > 0) {
      config.commandBat.forEach((cmd) => {
        script += `${cmd}\n`;
      });
    }

    script += `echo.\n`;
  });

  return script + '\n';
};

/**
 * Generate batch script footer
 */
const generateBatchFooter = () => {
  return `::============================================
:: INSTALLATION COMPLETE
::============================================
echo.
echo ========================================
echo Installation Complete!
echo ========================================
echo.
echo Next steps:
echo   1. Restart your computer if required
echo   2. Log into your installed applications
echo   3. Customize your settings as needed
echo.
echo If any installations failed, check errors.log
echo.
echo Generated by Windows Post-Install Generator
echo https://github.com/kaic/win-post-install
echo.
pause
`;
};
